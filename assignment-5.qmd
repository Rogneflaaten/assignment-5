---
title: "Assignment 5"
format: html
editor_options: 
  chunk_output_type: console
bibliography: referanser.bib
csl: apa.csl
---
```{r}
#| label: "setup"
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(exscidata)
library(lme4)
library(emmeans)
library(pbkrtest)
library(lmerTest)
library(cowplot)
library(gt)
library(webshot2)
library(patchwork)
library(png)


data("strengthvolume")
data("dxadata")

data <- dxadata %>%
  select(participant:include, lean.left_leg, lean.right_leg) %>%
  pivot_longer(names_to = "leg", 
               values_to = "lean.mass", 
               cols = lean.left_leg:lean.right_leg) %>%
  mutate(leg = if_else(leg == "lean.left_leg", "L", "R"), 
         sets = if_else(multiple == leg, "multiple", "single")) %>%
  select(participant, time, sex, include, sets, leg, lean.mass) %>%
  full_join(strengthvolume) %>% 
  filter(exercise == "legext",
         !is.na(load)) %>%
    group_by(participant) %>% 
    filter(n() == 12) %>% 
  ungroup() %>%
  mutate(time = factor(time, levels = c("pre", "session1", "week2", "week5", "week9", "post")),
         sets = factor(sets, levels = c("single", "multiple")),
         timec = as.numeric(case_when(time == "pre" ~ 0,
                                      time == "session1" ~ 0,
                                      time == "week2" ~ 2,
                                      time == "week5" ~ 5,
                                      time == "week9" ~ 9,
                                      time == "post" ~ 12)))

```

## Introduksjon
I utrente personer som begynner med styrketrening varierer økningen i muskelstyrke, målt som 1RM, med 1% per økt, men med en variasjon på hele 0.1-3% [@mcdonagh_adaptive_1984], og tverrsnittet til de styrketrente musklene øker 0.1-0.5% per økt [@wernbom_influence_2007]. Den store varisjonen i styrke- og muskelvekst er sannsynligvis avhengig av hvilken muskelgruppe som trenes, fibertypesammensetning, antall serier, repetisjoner, intensitet, pausetid og genetiske ulikheter [@tonnessen_trening_2018; @wackerhage_molecular_2014; @raastad_styrketrening_2010]. 

Sannsynligvis er det et dose-respons-forhold mellom treningsmengde og styrkeøkning per tidsenhet [@raastad_styrketrening_2010]. Treningsmengden er både avhengig av antall økter i uka og hvor mange serier eller øvelser vi trener på hver muskegruppe. Ettersom tidsbegrensninger ofte hindrer deltakere i treningsprogrammer [@choi_correlates_2017] er det av interesse å finne den minimale treningsdosen som gir gunstige adaptasjoner. Oversiktsarikler fra en amerikansk forskergruppe løfter konseptet om at en serie i hver øvelse er den mest effektive treningsformen [@carpinelli_strength_1998; @carpinelli_berger_2002]. Videre hevder de at det er bortkastet tid å gjennomføre mer enn en serie på en muskelgruppe. Andre meta-analyser viser at moderate treningsvolum (3 serier) er fordelaktig [@krieger_single_2009; @krieger_single_2010]. Disse ambivalente resultatene skyldes til dels denne store interindivid-variasjonen i treningsrespons. Intraindivide studiedesign med unilateral treningsvolum grupper vil trolig fjerne mye usikkerhet.

Målet med denne studien var å undersøke effekten av single- og multiserie (3 serier) treningsprotokoller på muskelstyrke og muskelmasse med et intraindivid studiedesign. 



## Metode

### Deltakere og studiedesign
41 menn og kvinner deltakere ble rekrutert til den nåværende studien med initielle kriterier som ikke-røykene og alder mellom 18 og 40 år. Eksklusjonskriteriene var intoleranse til lokal bedøvelse, mer enn en ukentlig styrketreningsøkt det siste året, redusert muskelstyrke pga tidligere eller nåværende skader, og intak av medikamenter som kan påvirke adaptasjoner til trening. I dataanalysen ble alle deltakere som ikke gjennomførte kneekstensjonsstesting på hvert tidspunkt brukt (N = 22). Deltakernes karakteristikker vises i @tbl-kar.

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: "tbl-kar"
#| tbl-cap: "Karakteristikker av deltakerne ved pretest"


dxadata %>%
  select(participant:weight, lean.left_leg, lean.right_leg) %>%
  pivot_longer(names_to = "leg", 
               values_to = "lean.mass", 
               cols = lean.left_leg:lean.right_leg) %>% 
  mutate(leg = if_else(leg == "lean.left_leg", "L", "R"), 
         sets = if_else(multiple == leg, "multiple", "single"),
         lean.mass = lean.mass / 1000) %>%
  select(participant, age, height, weight, time, sex, include, sets, leg, lean.mass) %>%
  full_join(strengthvolume) %>% 
  filter(exercise == "legext",
         !is.na(load)) %>%
    group_by(participant) %>% 
    filter(n() == 12) %>% 
  ungroup() %>% 
  filter(time == "pre") %>% 
  group_by(sets) %>% 
  mutate(N = n()) %>%
  pivot_longer(names_to = "variable",
               values_to = "values",
               cols = c(age, height, weight, lean.mass, load, N)) %>% 
  group_by(variable) %>% 
  summarise(Mean = mean(values, na.rm = T),
            SD = sd(values, na.rm = T)) %>% 
   mutate(MS = if_else(variable == "N",
                      as.character(Mean),
                      paste0(signif(Mean, 3),
                             " (",
                        signif(SD, 3), 
                        ")"))) %>% 
  select(-Mean, -SD) %>%
  mutate(variable = factor(variable, levels = c("N", 
                                                "age", 
                                                "height", 
                                                "weight", 
                                                "lean.mass", 
                                                "load"), 
                           labels = c("N", 
                                      "Alder", 
                                      "Kroppslengde", 
                                      "Kroppsvekt", 
                                      "Fettfri Masse", 
                                      "1RM Kneekstensjon"))) %>% 
  arrange(variable) %>% 
  gt() %>% 
  cols_label(variable = "",
             MS = "gj.snitt (SD)") %>% 
  tab_footnote(footnote = "Forkortelser: lean.mass, fettfri masse; load, 1RM kneekstensjon")
  
  
```


Intervensjonen bestå av 12 uker med helkropp styrketrening, alle deltakerne gjennomførte intervensjonen i løpet av september til november. Bein-øvelser ble utført unilateralt for å tillate innen-deltaker forskjeller i treningsvolum. Videre ble beinene til deltakerne tilfeldig fordelt til å utføre enten en serie (1 serie gruppen) og tre serier (3 serier gruppen), hver deltaker gjennomførte dermed begge protokollene. Maksimal muskelstyrke i kneekstensjon ble testet før (pre), underveis (uke 3, 5 og 9) og etter (post) intervensjonen. Kroppssammensetning ble målt før og etter treningsintervensjonen.

### DXA
Kroppssammensetning ble bestemt før og etter intervensjonen med bruk av dual-energy X-ray absorptiometry (DXA) (Lunar Prodigy, GE Healthcare, Oslo, Norge), iht standard protokoll. Før DXA målinger ble deltakerne bedt om å være fastende i minimum to timer og frastå all fysisk anstrengende aktivitet de siste 48 timene. Mellom DXA målinger og forrige stykeøkt var det to dager.

### Maksimal Styrke i kneekstensjon
Maksimal stykre i kneekstensjon ble målt som den høyeste repetisjonen (1RM) i en unilateral kneekstensjon. Testprotokollen begynte med en spesifikk oppvarming bestående av 10, 6 og 3 repetisjoner på 50, 75 og 85% av predikert 1RM. Deretter ble 1RM fundet ved å øke motstanden (kg) progresivt inntil vekten ikke ble løftet i hele bevegelsesbanen, den høyeste vekten med fult bevegelsesutslag ble definert som 1RM. Hver deltaker fikk 4-6 forsøk.

### Dataanalyse og Statistikk
All beskrvende data er presentert som gj.snitt (standardfeil) om annet ikke er spesifisert. For å undersøke effekten av treningsvolum på muskelhypertrofi og styrke ble det brukt mixed linear models (LLMs) spesifisert med tid og tid til treningsvolum interaksjoner som fikserte effekter. LMMs ble spesifisert med tilfeldige intercepts for deltakerne. Plotter med residualer mot predikerte verdier ble visuelt inspisert for antakelser om homoskedastisitet. Statistisk signifikansnivå ble satt til < 0.05.

## Resultat

```{r}
#| include: false
#| warning: false
#| message: false

change_lbm <- data %>% 
  filter(time == "pre" | time == "post") %>% 
  pivot_wider(names_from = time,
              values_from = lean.mass) %>% 
  mutate(change = post - pre) %>% 
  summarise(m = mean(change, na.rm = T),
            sd = sd(change, na.rm = T),
            se = sd / sqrt(18)) %>% 
  print()
```

Concomitantly, multiple-set resistance-training led to greater increases in muscle strength over the course of the intervention than single-set training (all variables P < 0.05, Fig. 2C and D). This difference in strength gain gradually increased over the first 9 weeks of the study (Fig. 2E). In line with this, multiple-set training led to greater increases in knee extensor CSA (mean percentage-point difference 1.62, [0.75, 2.50], P < 0.001, Fig. 2B).

Det ble ikke observert en effekt av treningsvolum på verken utvikling i 1RM kneekstensjon eller fettfrimasse i bein etter treningsintervensjonen, se @fig-str og @fig-lbm. 

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: "fig-str"
#| fig-cap: "Volumavhengig effekt på muskelstyrke"


fig1 <- data %>% 
  group_by(time, sets) %>% 
  summarise(Mean = mean(load, na.rm = T),
            SD = sd(load, na.rm = T)) %>% 
  mutate(timec = as.numeric(case_when(time == "pre" ~ 0,
                                      time == "session1" ~ 0,
                                      time == "week2" ~ 2,
                                      time == "week5" ~ 5,
                                      time == "week9" ~ 9,
                                      time == "post" ~ 12))) %>% 
  ggplot(aes(timec, Mean, group = sets, color = sets)) +
  geom_line(position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7),
             size = 3) +
  scale_x_continuous(breaks = seq(0, 16, 1)) +
  scale_y_continuous(breaks = seq(50, 100, 5)) +
  labs(x = "Tid (uker)",
       y = "1RM Kneekstensjon (kg)",
       color = "Treningsvolum",
       tag = "A") +
  theme_classic()

tab1 <- data %>% 
  group_by(time, sets) %>% 
  summarise(Mean = mean(load, na.rm = T),
            SD = sd(load, na.rm = T),
            N = n()) %>% 
   mutate(MS = if_else(time == "N",
                      as.character(Mean),
                      paste0(signif(Mean, 3),
                             " (",
                        signif(SD, 3), 
                        ")"))) %>% 
  select(-Mean, -SD, -N) %>% 
  pivot_wider(names_from = time,
              values_from = MS) %>% 
  gt() %>% 
  cols_label(sets = "Treningsvolum",
             pre = "Pretest",
             session1 = "Trening 1",
             week2 = "Uke 2",
             week5 = "Uke 5",
             week9 = "Uke 9",
             post = "Posttest") %>% 
  tab_spanner(label = "Tidspunkt",
              columns = pre:post) %>% 
  tab_header(title = "B") %>% 
  tab_footnote(footnote = "Data er presenter som gj.snitt (standardfeil)")

tmp <- tempfile(fileext = '.png') #generate path to temp .png file
gtsave(tab1, tmp) #save gt table as png
table_png <- png::readPNG(tmp, native = TRUE) # read tmp png file



fig1 / table_png



```

@tbl-str viser modelkoeffisienter fra LMMs for muskelstyrke.

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: "tbl-str"
#| tbl-cap: "Volumavhengig effekt på muskelstyrke fra LMM"

# The lmer function from the lme4 package.
m1_str <- lmer(load ~ timec * sets + (1|participant), data = data)

res_str <- summary(m1_str)$coef %>% 
  data.frame() %>% 
  mutate(Koeffisienter = c("Intercept", "Tid", "Gruppe3serier", "Tid:Gruppe3serier")) %>% 
  select(Koeffisienter, Estimate, Std..Error, df, t.value, Pr...t..) %>% 
  gt() %>% 
  cols_label(Estimate = "estimat",
             Std..Error = "se",
             df = "df",
             t.value = "t.verdi",
             Pr...t.. = "p.verdi") %>% 
  fmt_number(columns = Estimate:Pr...t.., decimals = 2) %>% 
  tab_footnote(footnote = "Forkortelser: se, standardfeil; df, frihetsgrader")

res_str
```

@tbl-lbm viser modelkoeffisienter fra LMMs for fettfrimasse i beinene.

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: "tbl-lbm"
#| tbl-cap: "Volumavhegig effekt på muskelmasse fra LMM"


data_lmb <- data %>% 
  filter(time == "pre" | time == "post") %>% 
  select(participant, time, sets, lean.mass) %>% 
  mutate(lean.mass = lean.mass / 1000)

m1_lbm <- lmer(lean.mass ~ time * sets + (1|participant), data = data_lmb)

res_lbm <- summary(m1_lbm)$coef %>% 
  data.frame() %>% 
   mutate(Koeffisienter = c("Intercept", "Tid", "Gruppe3serier", "Tid:Gruppe3serier")) %>% 
  select(Koeffisienter, Estimate, Std..Error, df, t.value, Pr...t..) %>% 
  gt() %>% 
  cols_label(Estimate = "estimat",
             Std..Error = "se",
             df = "df",
             t.value = "t.verdi",
             Pr...t.. = "p.verdi") %>% 
  fmt_number(columns = Estimate:Pr...t.., decimals = 2) %>% 
  tab_footnote(footnote = "Forkortelser: se, standardfeil; df, frihetsgrader")

res_lbm

```

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: "fig-lbm"
#| fig-cap: "Volumavhengig effekt på muskelmasse"
#| fig-subcap: "Figur A viser endring i fettfri masse fra pre- til posttest for begge volumgruppene. Figur B viser den gjennomsnittlige forskjellen mellom volumgruppene for både pre- og posttest"



## Figure 1: Estimated means and raw data

est_lbm <- emmeans(m1_lbm, specs = ~ time|sets)

figA <- est_lbm %>%
  data.frame() %>%
  
  ggplot(aes(time, emmean, group = sets, color = sets) ) +
    # Adds raw data
  geom_line(data = data_lmb, aes(time, lean.mass, group = participant, color = sets), 
            # Add transparency to individual lines
            alpha = 0.4) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), 
                position = position_dodge(width = 0.2), 
                width = 0.15,
                size = 0.4,
                color = "black") +
  geom_line(position = position_dodge(width = 0.2)) +
  geom_point(position = position_dodge(width = 0.2),
             size = 3) +
  theme_classic() +
  
  # Changing axis titles and title in the legend
  labs(y = "Fettfri masse (kg)", 
       color = "Treningsvolum",
       tag = "A") +
   theme(axis.text.x = element_blank(), 
        axis.title.x = element_blank())
  

# Save the confidence intervals
conf_intervals_lbm <- confint(m1_lbm)

# Save the regression coefficients
coefs_lbm <- summary(m1_lbm)$coef

# Using cbind (column bind) to combine the two data frames
coef_summary_lbm <- cbind(coefs_lbm, data.frame(conf_intervals_lbm)[3:6, ]) 


# Figure B: Differences between groups (interaction terms with 95% CI)
figB <- coef_summary_lbm %>%
  mutate(coef = rownames(.)) %>%
  # Filter only the interaction variables
  filter(coef %in% c("setsmultiple", "timepost:setsmultiple")) %>% 
  # Make a "timepoint" variable to represent the "dat" data set.
  mutate(time = gsub("time", "", coef), 
         time = gsub(":setsmultiple", "", time), 
         time = if_else(time == "setsmultiple", "pre", time)) %>%
  # Fix order of the time variable
  mutate(time = factor(time, levels = c("pre", "post"))) %>%
  
  # Create the plot
  ggplot(aes(time, Estimate)) + 
  
  
  # Add a line indicating zero geom_hline (horizontal line)
  geom_hline(yintercept = 0, lty = 2) +
  
  geom_errorbar(aes(ymin = X2.5.., ymax = X97.5..), width = 0.1) +
  geom_point(shape = 24, size = 3, fill = "orange") +
  theme_classic() + 
  
    # Changing axis titles and title in the legend
  labs(y = "Gj.snitt gruppevis forskjell\n(kg, 95% CI)",
       x = "Tidspunkt",
       tag = "B") 

  
# Using cowplot to plot both figures in 1


# Plot grid using figA and figB
plot_grid(figA, figB, ncol = 1, 
          # Align vertically so that the x axis matches
          align = "v", 
          # Set alignment so that axis align both on the left (l) and right (r)
          # axis
          axis = "lr")
```



## Diskusjon

## Referanser